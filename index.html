<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Civ-Aegis Ultimate</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        /* Custom Animations */
        @keyframes pulse-ring {
            0% { transform: scale(0.33); opacity: 0; }
            80%, 100% { opacity: 0; }
        }
        @keyframes pulse-dot {
            0% { transform: scale(0.8); }
            50% { transform: scale(1); }
            100% { transform: scale(0.8); }
        }
        .pulse-ring {
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            border: 4px solid #ef4444;
            animation: pulse-ring 1.25s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        .pulse-dot {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #ef4444;
            animation: pulse-dot 1.25s cubic-bezier(0.455, 0.03, 0.515, 0.955) -0.4s infinite;
        }
    </style>
</head>
<body class="bg-slate-900 text-white h-screen w-screen overflow-hidden">
    
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURATION ---
        // REPLACE THESE WITH YOUR EMAILJS KEYS LATER
        const EMAILJS_SERVICE_ID = "YOUR_SERVICE_ID";
        const EMAILJS_TEMPLATE_ID = "YOUR_TEMPLATE_ID";
        const EMAILJS_PUBLIC_KEY = "YOUR_PUBLIC_KEY";

        const { useState, useEffect, useRef } = React;

        // --- LANGUAGE DICTIONARY ---
        const TRANSLATIONS = {
            'en': {
                guardian: "GUARDIAN MODE",
                bystander: "BYSTANDER MODE",
                detecting: "SENSORS ACTIVE",
                crash_detected: "CRASH DETECTED",
                sending_help: "SENDING SOS IN",
                cancel: "I AM OKAY",
                sos_sent: "SOS SENT",
                ai_scan: "AI TRIAGE SCAN",
                analyzing: "Analyzing Vitals...",
                injury: "SUSPECTED SPINAL INJURY",
                instruction: "DO NOT MOVE VICTIM",
                settings: "Emergency Settings"
            },
            'es': {
                guardian: "MODO GUARDIÁN",
                bystander: "MODO TESTIGO",
                detecting: "SENSORES ACTIVOS",
                crash_detected: "CHOQUE DETECTADO",
                sending_help: "ENVIANDO AYUDA EN",
                cancel: "ESTOY BIEN",
                sos_sent: "SOS ENVIADO",
                ai_scan: "ESCANEO IA",
                analyzing: "Analizando Signos...",
                injury: "POSIBLE LESIÓN COLUMNA",
                instruction: "NO MOVER A LA VÍCTIMA",
                settings: "Configuración"
            }
            // Add 'fr', 'hi' here as needed
        };

        // --- MAIN APP COMPONENT ---
        function App() {
            // STATE
            const [mode, setMode] = useState('LANDING'); // LANDING, GUARDIAN, BYSTANDER, SETTINGS
            const [crashStatus, setCrashStatus] = useState('IDLE'); // IDLE, DETECTED, CONFIRMED
            const [timer, setTimer] = useState(20);
            const [lang, setLang] = useState('en');
            const [contact, setContact] = useState({ name: '', phone: '', email: '' });
            const [perms, setPerms] = useState(false); // Permissions granted?

            // REFS
            const videoRef = useRef(null);
            const mapRef = useRef(null);

            // --- INITIALIZATION ---
            useEffect(() => {
                // Initialize EmailJS
                emailjs.init(EMAILJS_PUBLIC_KEY);
                
                // Load Settings
                const saved = localStorage.getItem('civ_aegis_contact');
                if (saved) setContact(JSON.parse(saved));

                // Detect Language
                const browserLang = navigator.language.split('-')[0];
                if (TRANSLATIONS[browserLang]) setLang(browserLang);
                
                // Request Wake Lock if possible
                if ('wakeLock' in navigator) {
                    try { navigator.wakeLock.request('screen'); } catch(e) { console.log(e); }
                }
            }, []);

            // --- CRASH LOGIC (GUARDIAN) ---
            useEffect(() => {
                if (mode !== 'GUARDIAN') return;

                let lastX, lastY, lastZ;
                const threshold = 25; // Sensitivity

                const handleMotion = (event) => {
                    if (crashStatus !== 'IDLE') return;

                    const current = event.accelerationIncludingGravity;
                    if (!current) return;

                    const deltaX = Math.abs(current.x - lastX);
                    const deltaY = Math.abs(current.y - lastY);
                    const deltaZ = Math.abs(current.z - lastZ);

                    if (deltaX + deltaY + deltaZ > threshold) {
                        triggerCrash();
                    }

                    lastX = current.x;
                    lastY = current.y;
                    lastZ = current.z;
                };

                // Voice Recognition Setup (Simple version)
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    const recognition = new SpeechRecognition();
                    recognition.continuous = true;
                    recognition.lang = lang === 'es' ? 'es-ES' : 'en-US';
                    
                    recognition.onresult = (event) => {
                        const last = event.results.length - 1;
                        const command = event.results[last][0].transcript.toLowerCase();
                        console.log("Voice Command:", command);
                        
                        if (command.includes('help') || command.includes('crash') || command.includes('ayuda')) {
                            confirmCrash();
                        }
                        if (command.includes('cancel') || command.includes('stop')) {
                            cancelCrash();
                        }
                    };
                    recognition.start();
                    return () => { 
                        window.removeEventListener('devicemotion', handleMotion);
                        recognition.stop();
                    };
                }

                window.addEventListener('devicemotion', handleMotion);
                return () => window.removeEventListener('devicemotion', handleMotion);

            }, [mode, crashStatus]);

            // --- TIMER LOGIC ---
            useEffect(() => {
                let interval;
                if (crashStatus === 'DETECTED' && timer > 0) {
                    interval = setInterval(() => setTimer(t => t - 1), 1000);
                    // Play Beep
                    const beep = new Audio('https://www.soundjay.com/buttons/beep-01a.mp3'); 
                    beep.play().catch(e => console.log("Audio play failed"));
                } else if (timer === 0 && crashStatus === 'DETECTED') {
                    confirmCrash();
                }
                return () => clearInterval(interval);
            }, [crashStatus, timer]);


            // --- ACTIONS ---
            const triggerCrash = () => {
                setCrashStatus('DETECTED');
                setTimer(20);
            };

            const cancelCrash = () => {
                setCrashStatus('IDLE');
                setTimer(20);
            };

            const confirmCrash = () => {
                setCrashStatus('CONFIRMED');
                
                // 1. Get GPS
                navigator.geolocation.getCurrentPosition((pos) => {
                    const { latitude, longitude } = pos.coords;
                    const mapLink = `https://www.google.com/maps?q=${latitude},${longitude}`;

                    // 2. Send SMS (Foreground)
                    const msg = `SOS! I crashed. Location: ${mapLink}`;
                    window.location.href = `sms:${contact.phone}?body=${encodeURIComponent(msg)}`;

                    // 3. Send Email (Background)
                    if (contact.email) {
                        emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
                            user_name: contact.name,
                            location_map_link: mapLink,
                            time: new Date().toLocaleTimeString(),
                            to_email: contact.email
                        });
                    }
                }, (err) => alert("GPS Error: " + err.message));
            };

            const t = (key) => TRANSLATIONS[lang][key] || TRANSLATIONS['en'][key];


            // --- RENDER HELPERS ---
            const renderLanding = () => (
                <div className="flex flex-col h-full p-6 justify-center gap-6">
                    <h1 className="text-4xl font-mono font-bold text-center text-cyan-400 mb-8 tracking-widest">CIV-AEGIS</h1>
                    
                    <button onClick={() => { setMode('GUARDIAN'); setPerms(true); }} 
                        className="h-40 bg-slate-800 border-2 border-slate-600 rounded-2xl flex flex-col items-center justify-center active:scale-95 transition-all">
                        <i data-lucide="shield" class="w-12 h-12 text-green-400 mb-2"></i>
                        <span className="text-2xl font-bold">{t('guardian')}</span>
                    </button>

                    <button onClick={() => setMode('BYSTANDER')} 
                        className="h-40 bg-slate-800 border-2 border-slate-600 rounded-2xl flex flex-col items-center justify-center active:scale-95 transition-all">
                        <i data-lucide="eye" class="w-12 h-12 text-cyan-400 mb-2"></i>
                        <span className="text-2xl font-bold">{t('bystander')}</span>
                    </button>

                    <button onClick={() => setMode('SETTINGS')} className="mt-4 text-slate-400 flex items-center justify-center gap-2">
                        <i data-lucide="settings" class="w-5 h-5"></i> {t('settings')}
                    </button>
                </div>
            );

            const renderGuardian = () => (
                <div className="h-full flex flex-col items-center justify-center bg-black relative">
                    {crashStatus === 'IDLE' && (
                        <>
                            <div className="pulse-ring"></div>
                            <div className="pulse-dot"></div>
                            <h2 className="mt-80 text-xl font-mono animate-pulse">{t('detecting')}</h2>
                            <p className="text-xs text-gray-500 mt-2">Listening for: "HELP" / "CANCEL"</p>
                            
                            {/* HIDDEN SIMULATE BUTTON FOR DEMO */}
                            <button onClick={triggerCrash} className="absolute bottom-5 right-5 opacity-10 w-20 h-20 bg-red-500"></button>
                            <button onClick={() => setMode('LANDING')} className="absolute top-5 left-5 text-gray-500">EXIT</button>
                        </>
                    )}

                    {crashStatus === 'DETECTED' && (
                        <div className="absolute inset-0 bg-red-600 flex flex-col items-center justify-center animate-pulse z-50">
                            <h1 className="text-5xl font-black mb-4 text-center">{t('crash_detected')}</h1>
                            <div className="text-9xl font-mono mb-8">{timer}</div>
                            <div className="text-xl mb-12">{t('sending_help')}</div>
                            
                            <button onClick={cancelCrash} className="w-64 h-20 bg-white text-red-600 font-bold text-2xl rounded-full shadow-lg">
                                {t('cancel')}
                            </button>
                        </div>
                    )}

                    {crashStatus === 'CONFIRMED' && (
                        <div className="flex flex-col items-center text-center p-6">
                            <i data-lucide="check-circle" class="w-24 h-24 text-green-500 mb-4"></i>
                            <h1 className="text-3xl font-bold text-green-500">{t('sos_sent')}</h1>
                            <p className="mt-4 text-gray-400">Notifying contacts...</p>
                            <button onClick={() => setMode('LANDING')} className="mt-12 px-6 py-3 border border-gray-600 rounded">Home</button>
                        </div>
                    )}
                </div>
            );

            const renderBystander = () => {
                // Mock AI Delay
                const [scanned, setScanned] = useState(false);
                
                useEffect(() => {
                    const timer = setTimeout(() => {
                        setScanned(true);
                        // Speak
                        const u = new SpeechSynthesisUtterance(t('injury') + ". " + t('instruction'));
                        u.lang = lang === 'es' ? 'es-ES' : 'en-US';
                        window.speechSynthesis.speak(u);
                    }, 3000);
                    
                    // Init Map
                    setTimeout(() => {
                        if(!mapRef.current) {
                            const map = L.map('map').setView([51.505, -0.09], 13);
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                            L.marker([51.505, -0.09]).addTo(map).bindPopup('Nearest Hospital').openPopup();
                            mapRef.current = map;
                        }
                    }, 500);

                    // Start Camera
                    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                        .then(stream => { if(videoRef.current) videoRef.current.srcObject = stream; })
                        .catch(err => console.log("Camera Error", err));
                        
                    return () => clearTimeout(timer);
                }, []);

                return (
                    <div className="h-full relative flex flex-col">
                        {/* Camera Section */}
                        <div className="relative h-2/3 bg-black">
                            <video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover opacity-70"></video>
                            
                            {/* HUD Overlay */}
                            <div className="absolute inset-0 border-4 border-cyan-500/30 m-4 pointer-events-none rounded-lg flex flex-col justify-between p-4">
                                <div className="flex justify-between items-start">
                                    <span className="bg-cyan-500/20 text-cyan-400 px-2 py-1 text-xs font-mono border border-cyan-500/50 animate-pulse">{t('ai_scan')}</span>
                                    
                                    {/* Language Switcher */}
                                    <select onChange={(e) => setLang(e.target.value)} value={lang} className="pointer-events-auto bg-black text-white border border-gray-600 p-1 text-xs">
                                        <option value="en">English</option>
                                        <option value="es">Español</option>
                                    </select>
                                </div>

                                <div className="bg-black/80 p-4 border-t-2 border-cyan-500">
                                    {!scanned ? (
                                        <div className="text-cyan-400 font-mono animate-pulse">{t('analyzing')}</div>
                                    ) : (
                                        <div>
                                            <div className="text-red-500 font-black text-xl warning-flash">{t('injury')}</div>
                                            <div className="text-white text-sm mt-1">{t('instruction')}</div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Map Section */}
                        <div id="map" className="h-1/3 w-full bg-slate-800"></div>
                        
                        <button onClick={() => setMode('LANDING')} className="absolute top-4 left-4 z-50 bg-black/50 text-white p-2 rounded-full">
                            <i data-lucide="arrow-left" class="w-6 h-6"></i>
                        </button>
                    </div>
                );
            };

            const renderSettings = () => (
                <div className="p-6">
                    <h2 className="text-2xl font-bold mb-6">{t('settings')}</h2>
                    <div className="space-y-4">
                        <input placeholder="Contact Name" value={contact.name} onChange={e => setContact({...contact, name: e.target.value})} className="w-full p-3 bg-slate-800 rounded border border-slate-700" />
                        <input placeholder="Phone Number" value={contact.phone} onChange={e => setContact({...contact, phone: e.target.value})} className="w-full p-3 bg-slate-800 rounded border border-slate-700" />
                        <input placeholder="Email Address" value={contact.email} onChange={e => setContact({...contact, email: e.target.value})} className="w-full p-3 bg-slate-800 rounded border border-slate-700" />
                        <button onClick={() => {
                            localStorage.setItem('civ_aegis_contact', JSON.stringify(contact));
                            setMode('LANDING');
                        }} className="w-full bg-cyan-600 p-4 rounded font-bold mt-4">SAVE & EXIT</button>
                    </div>
                </div>
            );

            // --- MAIN RENDER SWITCH ---
            return (
                <div className="h-full w-full">
                    {mode === 'LANDING' && renderLanding()}
                    {mode === 'GUARDIAN' && renderGuardian()}
                    {mode === 'BYSTANDER' && renderBystander()}
                    {mode === 'SETTINGS' && renderSettings()}
                </div>
            );
        }

        // Render to DOM
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        
        // Initialize Icons
        setTimeout(() => lucide.createIcons(), 100);
    </script>
</body>
</html>